steps:
  - name: 'gcr.io/cloud-builders/npm'
    args: ['install']

  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'europe-west1-docker.pkg.dev/gkemedium/ethereum/getlastblocknumber-image', '.']
    env:
      - 'REGION=europe-west1'

  # Push the Docker image to Google Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'europe-west1-docker.pkg.dev/gkemedium/ethereum/getlastblocknumber-image']
    env:
      - 'REGION=europe-west1'

  # Custom script to create or update the Cloud Run job based on job existence
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if gcloud beta run jobs describe publishlatestblocknumbertopubsub --platform=managed --region=europe-west1 &> /dev/null; then
          gcloud beta run jobs update publishlatestblocknumbertopubsub \
            --image=europe-west1-docker.pkg.dev/gkemedium/ethereum/getlastblocknumber-image \
            --region=europe-west1 \
            --set-env-vars=PROJECT_ID=$PROJECT_ID,PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format=value(projectNumber))
        else
          gcloud beta run jobs create publishlatestblocknumbertopubsub \
            --image=europe-west1-docker.pkg.dev/gkemedium/ethereum/getlastblocknumber-image \
            --region=europe-west1 \
            --set-env-vars=PROJECT_ID=$PROJECT_ID,PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format=value(projectNumber))
        fi

timeout: 600s